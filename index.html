<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Meta 12kg - Tracker Inteligente</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .tap-effect:active { transform: scale(0.96); transition: transform 0.1s; }
        .view-section { display: none; opacity: 0; }
        .view-section.active { display: block; opacity: 1; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="text-slate-800 pb-24 select-none">

<!-- ============================================================
     ESTADO (SISTEMA QUINE)
     ============================================================ -->
<script id="app-state">
    /* STATE_START */
    (function(){var d=[];for(var i=1;i<=60;i++)d.push({day:i,weight:i===1?90:null,foods:[],activityType:null,activityKm:0,water:0,electrolytes:false});window.APP_DATA={config:{goalKg:12,durationDays:60,startWeight:90,currentWeight:90,height:0,age:0,sex:'M'},days:d};})();
    /* STATE_END */
</script>

<!-- ============================================================
     TOP NAV
     ============================================================ -->
<div class="fixed top-0 left-0 right-0 h-16 bg-white/90 backdrop-blur-md border-b border-slate-200 z-50 flex items-center justify-between px-5 shadow-sm">
    <div onclick="switchView('settings')" class="cursor-pointer">
        <h1 class="font-black text-xl tracking-tighter text-slate-900 leading-none">META <span class="text-emerald-600" id="header-goal">12KG</span></h1>
        <p class="text-[9px] font-extrabold text-slate-400 uppercase tracking-widest mt-0.5" id="header-day">DIA 1 ‚Ä¢ 60 DIAS</p>
    </div>
    <button onclick="downloadApp()" class="bg-slate-900 text-white p-2 rounded-full tap-effect shadow-lg shadow-slate-900/20">
        <span class="material-symbols-rounded">ios_share</span>
    </button>
</div>

<!-- ============================================================
     CONTE√öDO PRINCIPAL
     ============================================================ -->
<div class="pt-20 px-4 max-w-lg mx-auto w-full min-h-screen">

    <!-- VIEW: TRACKER -->
    <div class="view-section active space-y-5" id="view-tracker">

        <!-- Seletor de Dia -->
        <div class="flex items-center justify-between bg-white p-2 rounded-2xl shadow-sm border border-slate-200">
            <button onclick="changeDay(-1)" class="w-12 h-12 flex items-center justify-center text-slate-400 tap-effect">
                <span class="material-symbols-rounded">chevron_left</span>
            </button>
            <div class="text-center flex-1">
                <div id="day-label" class="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">Editando</div>
                <div class="text-2xl font-black text-slate-800">DIA <span id="display-day-num">1</span></div>
                <button id="btn-hoje" onclick="goToToday()" class="hidden text-[9px] font-bold text-emerald-600 mt-0.5 tap-effect">‚Üê Voltar ao Hoje</button>
            </div>
            <button onclick="changeDay(1)" class="w-12 h-12 flex items-center justify-center text-slate-400 tap-effect">
                <span class="material-symbols-rounded">chevron_right</span>
            </button>
        </div>

        <!-- Card de An√°lise (Gap) -->
        <div class="rounded-3xl p-5 text-white shadow-xl relative overflow-hidden" id="gap-card">
            <div class="relative z-10">
                <h3 class="text-xs font-bold uppercase opacity-60 mb-1">An√°lise de Meta</h3>
                <p class="text-lg font-bold leading-tight" id="gap-message">Calculando...</p>
                <div class="mt-4 pt-4 border-t border-white/10 flex justify-between items-end">
                    <div>
                        <span class="text-[10px] uppercase font-bold opacity-60 block">D√©ficit Hoje</span>
                        <span class="text-2xl font-black" id="today-deficit">‚Äî kcal</span>
                    </div>
                    <div class="text-right">
                        <span class="text-[10px] uppercase font-bold opacity-60 block">Status</span>
                        <span class="text-xs font-bold bg-white/20 px-2 py-0.5 rounded-full" id="status-badge">‚Äî</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ingest√£o -->
        <div class="bg-white rounded-3xl p-5 shadow-sm border border-slate-200">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest">Ingest√£o</h2>
                <span class="text-xs font-bold text-slate-800" id="today-kcal-total">0 kcal</span>
            </div>
            <div class="grid grid-cols-4 gap-2 mb-4">
                <button onclick="openFoodModal('meat')"    class="bg-slate-50 h-16 rounded-2xl flex items-center justify-center text-2xl tap-effect">ü•©</button>
                <button onclick="openFoodModal('chicken')" class="bg-slate-50 h-16 rounded-2xl flex items-center justify-center text-2xl tap-effect">üçó</button>
                <button onclick="openFoodModal('egg')"     class="bg-slate-50 h-16 rounded-2xl flex items-center justify-center text-2xl tap-effect">ü•ö</button>
                <button onclick="openFoodModal('cheese')"  class="bg-slate-50 h-16 rounded-2xl flex items-center justify-center text-2xl tap-effect">üßÄ</button>
            </div>
            <div id="food-log" class="space-y-2"></div>
        </div>

        <!-- Atividade (Calculadora) -->
        <div class="bg-white rounded-3xl p-5 shadow-sm border border-slate-200">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest">Atividade</h2>
                <span class="text-xs font-bold text-emerald-600" id="activity-kcal-label">+0 kcal</span>
            </div>

            <!-- Estado: sem atividade necess√°ria -->
            <div id="activity-no-need" class="hidden text-center py-3">
                <p class="text-xl mb-1">üéâ</p>
                <p class="text-xs font-bold text-emerald-600">Sem atividade necess√°ria!</p>
                <p class="text-[10px] text-slate-400 mt-0.5">O seu BMR j√° cobre o d√©ficit para hoje.</p>
            </div>

            <!-- Estado: recomenda√ß√£o de atividade -->
            <div id="activity-input" class="hidden">
                <p class="text-[10px] text-slate-500 mb-3">
                    Para atingir seu d√©ficit di√°rio voc√™ precisa queimar
                    <span class="font-bold text-slate-800" id="activity-burn-target">0</span> kcal com atividade.
                </p>
                <!-- Seletor de modalidade -->
                <div class="grid grid-cols-3 gap-2 mb-4">
                    <button onclick="selectActivity('walk')" class="activity-btn border-2 h-14 rounded-2xl flex flex-col items-center justify-center gap-0.5 tap-effect bg-emerald-50 border-emerald-500" data-type="walk">
                        <span class="text-lg">üö∂</span>
                        <span class="text-[8px] font-black text-slate-500 uppercase">Caminhada</span>
                    </button>
                    <button onclick="selectActivity('bike')" class="activity-btn border-2 h-14 rounded-2xl flex flex-col items-center justify-center gap-0.5 tap-effect bg-slate-50 border-transparent" data-type="bike">
                        <span class="text-lg">üö≤</span>
                        <span class="text-[8px] font-black text-slate-500 uppercase">Bike</span>
                    </button>
                    <button onclick="selectActivity('treadmill')" class="activity-btn border-2 h-14 rounded-2xl flex flex-col items-center justify-center gap-0.5 tap-effect bg-slate-50 border-transparent" data-type="treadmill">
                        <span class="text-lg">üèÉ</span>
                        <span class="text-[8px] font-black text-slate-500 uppercase">Esteira</span>
                    </button>
                </div>
                <!-- Km calculado -->
                <div class="bg-slate-50 rounded-2xl p-3 text-center mb-4">
                    <span class="text-4xl font-black text-slate-800" id="activity-km-display">0.0</span>
                    <span class="text-sm font-bold text-slate-400"> km</span>
                    <p class="text-[9px] text-slate-400 mt-1">= <span id="activity-burn-display">0</span> kcal de queima</p>
                </div>
                <button onclick="confirmActivity()" class="w-full bg-slate-900 text-white h-12 rounded-2xl font-bold text-sm shadow-lg tap-effect">
                    CONFIRMAR ATIVIDADE
                </button>
            </div>

            <!-- Estado: atividade j√° registrada -->
            <div id="activity-logged" class="hidden">
                <div class="flex items-center justify-between bg-slate-50 p-3 rounded-2xl border border-slate-100">
                    <div class="flex items-center gap-3">
                        <span class="text-xl" id="logged-activity-icon">üö∂</span>
                        <div>
                            <div class="text-[11px] font-black text-slate-700" id="logged-activity-name">Caminhada</div>
                            <div class="text-[10px] text-slate-400 font-bold" id="logged-activity-detail">0 km ‚Ä¢ 0 kcal</div>
                        </div>
                    </div>
                    <button onclick="removeActivity()" class="text-slate-200 hover:text-red-500">
                        <span class="material-symbols-rounded">close</span>
                    </button>
                </div>
                <!-- Alerta se insuficiente -->
                <div id="activity-warning" class="hidden mt-2 bg-blue-50 rounded-xl p-2">
                    <p class="text-[10px] font-bold text-blue-600" id="activity-warning-text">‚ö†Ô∏è Falta kcal para o d√©ficit</p>
                </div>
            </div>
        </div>

        <!-- Vitais -->
        <div class="grid grid-cols-2 gap-3">
            <div class="bg-white p-4 rounded-3xl border border-slate-200">
                <span class="text-[10px] font-bold text-slate-400 uppercase mb-2 block">L de √Ågua</span>
                <input type="number" id="inp-water" placeholder="0" onchange="syncData()" class="text-2xl font-black text-slate-800 w-full outline-none bg-transparent">
            </div>
            <div class="bg-white p-4 rounded-3xl border border-slate-200">
                <span class="text-[10px] font-bold text-slate-400 uppercase mb-2 block">Peso (kg)</span>
                <input type="number" id="inp-weight" placeholder="00.0" onchange="syncData()" class="text-2xl font-black text-slate-800 w-full outline-none bg-transparent">
            </div>
            <div class="bg-white p-3 rounded-3xl border border-slate-200 col-span-2 flex justify-between items-center">
                <span class="text-[10px] font-bold text-slate-400 uppercase">Sais Minerais</span>
                <input type="checkbox" id="inp-elec" onchange="syncData()" class="w-6 h-6 accent-emerald-500">
            </div>
        </div>
    </div>

    <!-- VIEW: DASHBOARD -->
    <div class="view-section space-y-5" id="view-dashboard">
        <!-- Card Peso + Progresso -->
        <div class="bg-slate-900 rounded-[40px] p-8 text-white shadow-2xl relative overflow-hidden">
            <div class="absolute right-[-30px] top-[-30px] opacity-10">
                <span class="material-symbols-rounded text-[180px]">monitoring</span>
            </div>
            <div class="relative z-10">
                <p class="text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">Peso Atual</p>
                <h2 class="text-6xl font-black mb-6 tracking-tighter" id="dash-weight">90kg</h2>
                <div>
                    <div class="flex justify-between text-[10px] font-bold text-slate-400 uppercase mb-2">
                        <span>Progresso Meta <span id="dash-goal-val">12</span>kg</span>
                        <span id="dash-pct">0%</span>
                    </div>
                    <div class="w-full bg-slate-800 rounded-full h-2.5 overflow-hidden">
                        <div class="bg-emerald-500 h-full rounded-full transition-all duration-1000" id="dash-bar" style="width:0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Grid -->
        <div class="grid grid-cols-2 gap-3">
            <div class="bg-white p-4 rounded-3xl border border-slate-200">
                <span class="text-[10px] font-bold text-slate-400 uppercase block mb-1">D√©ficit Acumulado</span>
                <span class="text-lg font-black text-slate-800" id="dash-deficit-total">0 kcal</span>
                <p class="text-[9px] text-slate-400 mt-0.5" id="dash-deficit-pct">de 0 kcal necess√°rios</p>
            </div>
            <div class="bg-white p-4 rounded-3xl border border-slate-200">
                <span class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Dias Registrados</span>
                <span class="text-lg font-black text-slate-800" id="dash-days-done">0</span>
                <p class="text-[9px] text-slate-400 mt-0.5" id="dash-days-remaining">de 60 dias no plano</p>
            </div>
            <div class="bg-white p-4 rounded-3xl border border-slate-200">
                <span class="text-[10px] font-bold text-slate-400 uppercase block mb-1">M√©dia Di√°ria</span>
                <span class="text-lg font-black text-slate-800" id="dash-avg-deficit">‚Äî kcal</span>
                <p class="text-[9px] text-slate-400 mt-0.5" id="dash-avg-target">alvo: ‚Äî kcal/dia</p>
            </div>
            <div class="bg-white p-4 rounded-3xl border border-slate-200">
                <span class="text-[10px] font-bold text-slate-400 uppercase block mb-1">Dias No Plano</span>
                <span class="text-lg font-black text-slate-800" id="dash-on-track">0</span>
                <p class="text-[9px] text-slate-400 mt-0.5" id="dash-on-track-pct">de 0 registrados</p>
            </div>
        </div>

        <!-- Gr√°fico -->
        <div class="bg-white p-5 rounded-3xl border border-slate-200 shadow-sm">
            <h3 class="text-xs font-bold text-slate-400 uppercase mb-6">Evolu√ß√£o do Peso</h3>
            <div class="h-64"><canvas id="weightChart"></canvas></div>
        </div>
    </div>

    <!-- VIEW: SETTINGS -->
    <div class="view-section space-y-5" id="view-settings">
        <div class="bg-white p-6 rounded-[40px] shadow-sm border border-slate-200">
            <h2 class="text-lg font-black text-slate-900 mb-1">Perfil</h2>
            <p class="text-xs text-slate-400 mb-5">Usado para calcular seu BMR (gasto em repouso).</p>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block">Sexo</label>
                    <div class="flex gap-3">
                        <button onclick="setCfgSex('M')" class="cfg-sex-btn flex-1 h-12 rounded-2xl font-bold text-sm border-2 tap-effect bg-emerald-50 border-emerald-500 text-emerald-700" data-sex="M">Masculino</button>
                        <button onclick="setCfgSex('F')" class="cfg-sex-btn flex-1 h-12 rounded-2xl font-bold text-sm border-2 tap-effect bg-slate-50 border-transparent text-slate-500" data-sex="F">Feminino</button>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Idade (anos)</label>
                        <input type="number" id="cfg-age" class="w-full p-3 bg-slate-50 rounded-2xl border-2 border-transparent focus:border-emerald-500 outline-none font-bold text-xl">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Estatura (cm)</label>
                        <input type="number" id="cfg-height" class="w-full p-3 bg-slate-50 rounded-2xl border-2 border-transparent focus:border-emerald-500 outline-none font-bold text-xl">
                    </div>
                </div>
                <div class="bg-emerald-50 border border-emerald-200 rounded-2xl p-3 flex justify-between items-center">
                    <span class="text-[10px] font-bold text-emerald-600 uppercase">BMR Calculado</span>
                    <span class="text-sm font-black text-emerald-700" id="cfg-bmr-display">‚Äî kcal/dia</span>
                </div>
            </div>
        </div>
        <div class="bg-white p-6 rounded-[40px] shadow-sm border border-slate-200">
            <h2 class="text-lg font-black text-slate-900 mb-1">Meta</h2>
            <p class="text-xs text-slate-400 mb-5">Defina seu objetivo de perda.</p>
            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Meta de Perda (kg)</label>
                    <input type="number" id="cfg-goal" class="w-full p-4 bg-slate-50 rounded-2xl border-2 border-transparent focus:border-emerald-500 outline-none font-bold text-xl">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Dura√ß√£o (dias)</label>
                    <input type="number" id="cfg-days" class="w-full p-4 bg-slate-50 rounded-2xl border-2 border-transparent focus:border-emerald-500 outline-none font-bold text-xl">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Peso Inicial (kg)</label>
                    <input type="number" id="cfg-start" class="w-full p-4 bg-slate-50 rounded-2xl border-2 border-transparent focus:border-emerald-500 outline-none font-bold text-xl">
                </div>
                <button onclick="saveConfig()" class="w-full bg-emerald-600 text-white h-16 rounded-2xl font-bold text-lg shadow-xl shadow-emerald-200 tap-effect mt-2">RECALCULAR TUDO</button>
            </div>
        </div>
        <div class="p-6 bg-slate-900 rounded-[40px] text-white">
            <h3 class="font-bold mb-2">Backup de Seguran√ßa</h3>
            <p class="text-xs text-slate-400">Seus dados s√£o salvos localmente. Use o bot√£o de download no topo para baixar o arquivo HTML com seu progresso inclu√≠do.</p>
        </div>
    </div>

</div><!-- fim main -->

<!-- ============================================================
     TAB BAR
     ============================================================ -->
<div class="fixed bottom-0 w-full bg-white/95 backdrop-blur-md border-t border-slate-200 h-20 flex justify-around items-start pt-3 z-50">
    <button onclick="switchView('tracker')" class="nav-btn text-emerald-600 flex flex-col items-center justify-center w-full tap-effect" data-id="tracker">
        <span class="material-symbols-rounded text-2xl mb-0.5">edit_square</span>
        <span class="text-[9px] font-black uppercase">Registro</span>
    </button>
    <button onclick="switchView('dashboard')" class="nav-btn text-slate-300 flex flex-col items-center justify-center w-full tap-effect" data-id="dashboard">
        <span class="material-symbols-rounded text-2xl mb-0.5">donut_large</span>
        <span class="text-[9px] font-black uppercase">An√°lise</span>
    </button>
    <button onclick="switchView('settings')" class="nav-btn text-slate-300 flex flex-col items-center justify-center w-full tap-effect" data-id="settings">
        <span class="material-symbols-rounded text-2xl mb-0.5">tune</span>
        <span class="text-[9px] font-black uppercase">Meta</span>
    </button>
</div>

<!-- ============================================================
     MODAL ‚Äî ALIMENTA√á√ÉO
     ============================================================ -->
<div id="modal-food" class="fixed inset-0 z-[100] hidden flex items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4">
    <div class="bg-white w-full max-w-sm rounded-[40px] p-8 shadow-2xl">
        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-3">
                <span id="m-food-icon" class="text-4xl">ü•©</span>
                <h3 id="m-food-name" class="font-black text-xl">Carne</h3>
            </div>
            <button onclick="closeFoodModal()" class="bg-slate-100 p-2 rounded-full">
                <span class="material-symbols-rounded">close</span>
            </button>
        </div>
        <input type="number" id="m-food-qty" placeholder="0" class="w-full text-center text-6xl font-black text-slate-800 bg-transparent border-b-2 border-slate-100 focus:border-emerald-500 outline-none h-24 mb-2">
        <p class="text-center text-[10px] font-black text-slate-300 uppercase tracking-widest mb-8" id="m-food-unit">GRAMAS</p>
        <button onclick="confirmFood()" class="w-full bg-slate-900 text-white h-16 rounded-3xl font-bold text-lg shadow-xl tap-effect">CONFIRMAR</button>
    </div>
</div>

<!-- ============================================================
     MODAL ‚Äî PRIMEIRO ACESSO (SETUP)
     ============================================================ -->
<div id="setup-modal" class="fixed inset-0 z-[200] bg-slate-900 flex flex-col items-center justify-center p-8 text-center hidden overflow-y-auto">
    <div class="w-24 h-24 bg-emerald-500/20 text-emerald-400 rounded-[35px] flex items-center justify-center mb-6 animate-pulse">
        <span class="material-symbols-rounded text-5xl">flag</span>
    </div>
    <h1 class="text-4xl font-black text-white mb-1 tracking-tighter">Primeiro Acesso</h1>
    <p class="text-slate-400 mb-8 text-sm max-w-xs mx-auto">Preenche os dados abaixo para o app calcular tudo corretamente.</p>
    <div class="w-full max-w-xs mb-6">
        <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 text-left">Sexo</p>
        <div class="flex gap-3">
            <button onclick="setSex('M')" class="setup-sex-btn flex-1 h-14 rounded-2xl font-bold text-white border-2 border-emerald-500 bg-emerald-500/20 tap-effect" data-sex="M">Masculino</button>
            <button onclick="setSex('F')" class="setup-sex-btn flex-1 h-14 rounded-2xl font-bold text-slate-500 border-2 border-slate-700 bg-transparent tap-effect" data-sex="F">Feminino</button>
        </div>
    </div>
    <div class="w-full max-w-xs mb-6">
        <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 text-left">Idade (anos)</p>
        <input type="number" id="setup-age" placeholder="00" class="bg-transparent border-b-2 border-slate-800 text-white text-4xl font-black text-left w-full outline-none focus:border-emerald-500 transition-colors">
    </div>
    <div class="w-full max-w-xs mb-6">
        <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 text-left">Estatura (cm)</p>
        <input type="number" id="setup-height" placeholder="000" class="bg-transparent border-b-2 border-slate-800 text-white text-4xl font-black text-left w-full outline-none focus:border-emerald-500 transition-colors">
    </div>
    <div class="w-full max-w-xs mb-8">
        <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-2 text-left">Peso atual (kg)</p>
        <input type="number" id="setup-weight" placeholder="00.0" class="bg-transparent border-b-2 border-slate-800 text-white text-4xl font-black text-left w-full outline-none focus:border-emerald-500 transition-colors">
    </div>
    <button onclick="initSetup()" class="w-full max-w-xs bg-emerald-500 text-white h-16 rounded-3xl font-bold text-lg shadow-xl shadow-emerald-500/20 tap-effect">INICIAR AGORA</button>
</div>

<!-- ============================================================
     SCRIPT PRINCIPAL
     ============================================================ -->
<script>
// ============================================================
// CONSTANTES
// ============================================================
const FOOD_DB = {
    meat:    { name:'Carne',  icon:'ü•©', unit:'g',    kcal:2.5  },
    chicken: { name:'Frango', icon:'üçó', unit:'g',    kcal:1.65 },
    egg:     { name:'Ovo',    icon:'ü•ö', unit:'unid', kcal:75   },
    cheese:  { name:'Queijo', icon:'üßÄ', unit:'g',    kcal:3.2  }
};

// Queima por km em cada modalidade
const ACTIVITY_DB = {
    walk:      { name:'Caminhada', icon:'üö∂', kcalPerKm:60 },
    bike:      { name:'Bike',      icon:'üö≤', kcalPerKm:35 },
    treadmill: { name:'Esteira',   icon:'üèÉ', kcalPerKm:70 }
};

// ============================================================
// BMR ‚Äî Mifflin-St Jeor (din√¢mico pelo peso atual)
// ============================================================
function calcBMR() {
    const cfg = window.APP_DATA.config;
    const peso   = cfg.currentWeight || cfg.startWeight || 70;
    const altura = cfg.height || 170;
    const idade  = cfg.age    || 25;
    // Masculino: 10√ópeso + 6.25√óaltura ‚àí 5√óidade + 5
    // Feminino:  10√ópeso + 6.25√óaltura ‚àí 5√óidade ‚àí 161
    const base = 10 * peso + 6.25 * altura - 5 * idade;
    return cfg.sex === 'F' ? base - 161 : base + 5;
}

// ============================================================
// ESTADO INTERNO
// ============================================================
let currentDay           = 1;   // dia que o usu√°rio est√° editando
let todayDay             = 1;   // dia "real" (primeiro dia sem dados)
let selectedFood         = null;
let selectedActivityType = 'walk';
let currentNeededBurn    = 0;   // kcal de atividade necess√°rios hoje
let currentDailyTarget   = 0;   // d√©ficit di√°rio alvo
let weightChart          = null;

// ============================================================
// CICLO DE VIDA
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
    // 1) Carregar localStorage
    const saved = localStorage.getItem('meta_pwa_data');
    if (saved) {
        try { window.APP_DATA = JSON.parse(saved); } catch(e) { /* ignora */ }
    }

    // 2) Migra√ß√£o: formato antigo (walkKm) ‚Üí novo (activityType + activityKm)
    if (window.APP_DATA.days.length > 0 && 'walkKm' in window.APP_DATA.days[0]) {
        window.APP_DATA.days.forEach(d => {
            d.activityType = d.walkKm > 0 ? 'walk' : null;
            d.activityKm   = d.walkKm || 0;
            delete d.walkKm;
        });
        saveAndSync();
    }

    // 3) Garantir campos existem em todos os dias
    window.APP_DATA.days.forEach(d => {
        if (d.activityType === undefined) d.activityType = null;
        if (d.activityKm   === undefined) d.activityKm   = 0;
    });

    // 4) Fluxo de entrada
    if (window.APP_DATA.config.startWeight === 0 || !window.APP_DATA.config.height || !window.APP_DATA.config.age) {
        // Preencher campos do setup com dados que j√° existam (migra√ß√£o)
        if (window.APP_DATA.config.startWeight) {
            document.getElementById('setup-weight').value = window.APP_DATA.config.startWeight;
        }
        if (window.APP_DATA.config.height) {
            document.getElementById('setup-height').value = window.APP_DATA.config.height;
        }
        if (window.APP_DATA.config.age) {
            document.getElementById('setup-age').value = window.APP_DATA.config.age;
        }
        setSex(window.APP_DATA.config.sex || 'M');
        document.getElementById('setup-modal').classList.remove('hidden');
    } else {
        initApp();
    }
});

function initApp() {
    // "Hoje" = primeiro dia sem nenhum dado registrado
    const idx = window.APP_DATA.days.findIndex(d =>
        !d.weight && d.foods.length === 0 && !d.activityKm
    );
    todayDay   = idx === -1 ? window.APP_DATA.config.durationDays : idx + 1;
    currentDay = todayDay;
    updateUI();
    initChart();
}

function initSetup() {
    const w = parseFloat(document.getElementById('setup-weight').value);
    const h = parseFloat(document.getElementById('setup-height').value);
    const a = parseFloat(document.getElementById('setup-age').value);
    if (!w || !h || !a) { alert('Preenche todos os campos por favor.'); return; }
    window.APP_DATA.config.startWeight   = w;
    window.APP_DATA.config.currentWeight = w;
    window.APP_DATA.config.height        = h;
    window.APP_DATA.config.age           = a;
    // sex j√° foi setado pelo setSex()
    window.APP_DATA.days[0].weight       = w;
    document.getElementById('setup-modal').classList.add('hidden');
    saveAndSync();
    initApp();
}

// Bot√£o sexo no modal de setup
function setSex(val) {
    window.APP_DATA.config.sex = val;
    document.querySelectorAll('.setup-sex-btn').forEach(btn => {
        const on = btn.dataset.sex === val;
        btn.classList.toggle('border-emerald-500',  on);
        btn.classList.toggle('bg-emerald-500/20',   on);
        btn.classList.toggle('text-white',          on);
        btn.classList.toggle('border-slate-700',   !on);
        btn.classList.toggle('bg-transparent',     !on);
        btn.classList.toggle('text-slate-500',     !on);
    });
}

// ============================================================
// PERSIST√äNCIA
// ============================================================
function saveAndSync() {
    localStorage.setItem('meta_pwa_data', JSON.stringify(window.APP_DATA));
}

function syncData() {
    const d = window.APP_DATA.days[currentDay - 1];
    d.water        = parseFloat(document.getElementById('inp-water').value)  || 0;
    d.weight       = parseFloat(document.getElementById('inp-weight').value) || null;
    d.electrolytes = document.getElementById('inp-elec').checked;
    recalcCurrentWeight();
    saveAndSync();
    updateUI();
}

// Recalcula currentWeight como o peso mais recente registrado
function recalcCurrentWeight() {
    for (let i = window.APP_DATA.days.length - 1; i >= 0; i--) {
        if (window.APP_DATA.days[i].weight) {
            window.APP_DATA.config.currentWeight = window.APP_DATA.days[i].weight;
            return;
        }
    }
}

function saveConfig() {
    const g = parseFloat(document.getElementById('cfg-goal').value);
    const d = parseInt(document.getElementById('cfg-days').value);
    const s = parseFloat(document.getElementById('cfg-start').value);
    const h = parseFloat(document.getElementById('cfg-height').value);
    const a = parseFloat(document.getElementById('cfg-age').value);
    if (!g || !d || !s || !h || !a) { alert('Preenche todos os campos por favor.'); return; }

    window.APP_DATA.config.goalKg       = g;
    window.APP_DATA.config.durationDays = d;
    window.APP_DATA.config.startWeight  = s;
    window.APP_DATA.config.height       = h;
    window.APP_DATA.config.age          = a;
    // sex j√° foi setado pelo setCfgSex()

    // Expandir dias se necess√°rio
    if (d > window.APP_DATA.days.length) {
        for (let i = window.APP_DATA.days.length; i < d; i++) {
            window.APP_DATA.days.push({
                day: i+1, weight: null, foods: [],
                activityType: null, activityKm: 0,
                water: 0, electrolytes: false
            });
        }
    }
    // Cortar dias se necess√°rio
    if (d < window.APP_DATA.days.length) {
        window.APP_DATA.days = window.APP_DATA.days.slice(0, d);
    }

    window.APP_DATA.days[0].weight = s;
    recalcCurrentWeight();
    saveAndSync();
    initApp();
    alert('Meta atualizada! Todo o plano foi recalculado.');
    switchView('tracker');
}

// Bot√£o sexo nas configura√ß√µes
function setCfgSex(val) {
    window.APP_DATA.config.sex = val;
    document.querySelectorAll('.cfg-sex-btn').forEach(btn => {
        const on = btn.dataset.sex === val;
        btn.classList.toggle('bg-emerald-50',       on);
        btn.classList.toggle('border-emerald-500',  on);
        btn.classList.toggle('text-emerald-700',    on);
        btn.classList.toggle('bg-slate-50',        !on);
        btn.classList.toggle('border-transparent', !on);
        btn.classList.toggle('text-slate-500',     !on);
    });
    updateUI();
}

// ============================================================
// GAP ANALYZER ‚Äî THE BRAIN
// ============================================================
function getActivityBurn(day) {
    if (!day.activityType || !day.activityKm) return 0;
    const db = ACTIVITY_DB[day.activityType];
    return db ? day.activityKm * db.kcalPerKm : 0;
}

function analyzeGap(totalFoodKcal) {
    const cfg           = window.APP_DATA.config;
    const totalKcalGoal = cfg.goalKg * 7700; // 7700 kcal ‚âà 1 kg

    // Somar d√©ficit dos dias ANTERIORES ao dia editado
    let deficitAccumulated = 0;
    let daysPassed         = 0;

    window.APP_DATA.days.forEach(d => {
        if (d.day < currentDay) {
            const kIn     = d.foods.reduce((a, f) => a + f.kcal, 0);
            const actBurn = getActivityBurn(d);
            deficitAccumulated += (calcBMR() + actBurn) - kIn;
            daysPassed++;
        }
    });

    // Dados do dia atual (editado)
    const todayData    = window.APP_DATA.days[currentDay - 1];
    const todayActBurn = getActivityBurn(todayData);
    const todayDeficit = (calcBMR() + todayActBurn) - totalFoodKcal;

    // Alvo di√°rio restante
    const remainingKcal = totalKcalGoal - deficitAccumulated;
    const remainingDays = cfg.durationDays - daysPassed;
    const dailyTarget   = remainingDays > 0 ? remainingKcal / remainingDays : remainingKcal;

    // Queima necess√°ria: dailyTarget = BMR + actBurn - foodIn
    //                    actBurn      = dailyTarget - BMR + foodIn
    const neededBurn = Math.max(0, dailyTarget - calcBMR() + totalFoodKcal);

    // Persistir para a se√ß√£o de atividade
    currentNeededBurn  = neededBurn;
    currentDailyTarget = dailyTarget;

    // --- Atualizar card do gap ---
    const msgEl   = document.getElementById('gap-message');
    const badgeEl = document.getElementById('status-badge');
    const cardEl  = document.getElementById('gap-card');

    if (todayDeficit >= dailyTarget) {
        msgEl.innerText   = 'Ritmo perfeito! D√©ficit atingido para o dia.';
        badgeEl.innerText = 'NO PLANO';
        cardEl.className  = 'bg-emerald-600 rounded-3xl p-5 text-white shadow-xl relative overflow-hidden';
    } else {
        const gap    = Math.round(dailyTarget - todayDeficit);
        const hasAct = todayData.activityType && todayData.activityKm > 0;
        msgEl.innerText = hasAct
            ? `Atividade registrada, mas falta +${gap} kcal de d√©ficit. Ajuste se necess√°rio.`
            : `Adicione atividade para cobrir os +${gap} kcal de d√©ficit restantes.`;
        badgeEl.innerText = 'ATRASO';
        cardEl.className  = 'bg-blue-600 rounded-3xl p-5 text-white shadow-xl relative overflow-hidden';
    }

    document.getElementById('today-deficit').innerText = Math.round(todayDeficit) + ' kcal';

    return { todayDeficit, dailyTarget, neededBurn };
}

// ============================================================
// ATIVIDADE
// ============================================================
function selectActivity(type) {
    selectedActivityType = type;
    refreshActivityButtons();
    refreshActivityKmDisplay();
}

function refreshActivityButtons() {
    document.querySelectorAll('.activity-btn').forEach(btn => {
        const on = btn.dataset.type === selectedActivityType;
        btn.classList.toggle('bg-emerald-50',       on);
        btn.classList.toggle('border-emerald-500',  on);
        btn.classList.toggle('bg-slate-50',        !on);
        btn.classList.toggle('border-transparent', !on);
    });
}

function refreshActivityKmDisplay() {
    const rate     = ACTIVITY_DB[selectedActivityType].kcalPerKm;
    const neededKm = currentNeededBurn > 0 ? currentNeededBurn / rate : 0;
    document.getElementById('activity-km-display').innerText   = neededKm.toFixed(1);
    document.getElementById('activity-burn-display').innerText = Math.round(currentNeededBurn);
}

function confirmActivity() {
    const rate = ACTIVITY_DB[selectedActivityType].kcalPerKm;
    const km   = currentNeededBurn > 0 ? currentNeededBurn / rate : 0;

    const day        = window.APP_DATA.days[currentDay - 1];
    day.activityType = selectedActivityType;
    day.activityKm   = parseFloat(km.toFixed(1));

    saveAndSync();
    updateUI();
    playSound();
}

function removeActivity() {
    const day        = window.APP_DATA.days[currentDay - 1];
    day.activityType = null;
    day.activityKm   = 0;
    saveAndSync();
    updateUI();
}

function updateActivitySection() {
    const day    = window.APP_DATA.days[currentDay - 1];
    const hasAct = day.activityType && day.activityKm > 0;

    const inputEl   = document.getElementById('activity-input');
    const noNeedEl  = document.getElementById('activity-no-need');
    const loggedEl  = document.getElementById('activity-logged');
    const kcalLabel = document.getElementById('activity-kcal-label');

    if (hasAct) {
        // --- Atividade j√° registrada ---
        inputEl.classList.add('hidden');
        noNeedEl.classList.add('hidden');
        loggedEl.classList.remove('hidden');

        const act  = ACTIVITY_DB[day.activityType];
        const burn = getActivityBurn(day);
        document.getElementById('logged-activity-icon').innerText   = act.icon;
        document.getElementById('logged-activity-name').innerText   = act.name;
        document.getElementById('logged-activity-detail').innerText = `${day.activityKm} km ‚Ä¢ ${Math.round(burn)} kcal`;
        kcalLabel.innerText = `+${Math.round(burn)} kcal`;

        // Alerta se insuficiente
        const foodKcal     = day.foods.reduce((a, f) => a + f.kcal, 0);
        const todayDeficit = (calcBMR() + burn) - foodKcal;
        const warningEl    = document.getElementById('activity-warning');
        if (todayDeficit < currentDailyTarget) {
            const shortfall = Math.round(currentDailyTarget - todayDeficit);
            warningEl.classList.remove('hidden');
            document.getElementById('activity-warning-text').innerText =
                `‚ö†Ô∏è Falta +${shortfall} kcal ‚Äî remova e reajuste a atividade`;
        } else {
            warningEl.classList.add('hidden');
        }

    } else if (currentNeededBurn <= 0) {
        // --- Sem atividade necess√°ria ---
        inputEl.classList.add('hidden');
        loggedEl.classList.add('hidden');
        noNeedEl.classList.remove('hidden');
        kcalLabel.innerText = '+0 kcal';

    } else {
        // --- Recomenda√ß√£o de atividade ---
        noNeedEl.classList.add('hidden');
        loggedEl.classList.add('hidden');
        inputEl.classList.remove('hidden');

        document.getElementById('activity-burn-target').innerText = Math.round(currentNeededBurn);
        kcalLabel.innerText = `+${Math.round(currentNeededBurn)} kcal`;
        refreshActivityButtons();
        refreshActivityKmDisplay();
    }
}

// ============================================================
// UI ENGINE
// ============================================================
function updateUI() {
    const cfg = window.APP_DATA.config;
    const day = window.APP_DATA.days[currentDay - 1];

    // --- Indicador de dia passado ---
    const dayLabel = document.getElementById('day-label');
    const btnHoje  = document.getElementById('btn-hoje');
    if (currentDay < todayDay) {
        dayLabel.innerText = 'Editando (dia passado)';
        dayLabel.className = 'text-[10px] font-bold text-blue-500 uppercase tracking-tighter';
        btnHoje.classList.remove('hidden');
    } else {
        dayLabel.innerText = 'Editando';
        dayLabel.className = 'text-[10px] font-bold text-slate-400 uppercase tracking-tighter';
        btnHoje.classList.add('hidden');
    }

    // --- Header ---
    document.getElementById('header-goal').innerText     = cfg.goalKg + 'KG';
    document.getElementById('header-day').innerText      = `DIA ${currentDay} ‚Ä¢ ${cfg.durationDays} DIAS`;
    document.getElementById('display-day-num').innerText = currentDay;

    // --- Inputs do tracker ---
    document.getElementById('inp-water').value  = day.water  || '';
    document.getElementById('inp-weight').value = day.weight || '';
    document.getElementById('inp-elec').checked = day.electrolytes;

    // --- Inputs do settings ---
    document.getElementById('cfg-goal').value   = cfg.goalKg;
    document.getElementById('cfg-days').value   = cfg.durationDays;
    document.getElementById('cfg-start').value  = cfg.startWeight;
    document.getElementById('cfg-height').value = cfg.height || '';
    document.getElementById('cfg-age').value    = cfg.age    || '';
    // Sexo nos bot√µes de configura√ß√µes
    document.querySelectorAll('.cfg-sex-btn').forEach(btn => {
        const on = btn.dataset.sex === cfg.sex;
        btn.classList.toggle('bg-emerald-50',       on);
        btn.classList.toggle('border-emerald-500',  on);
        btn.classList.toggle('text-emerald-700',    on);
        btn.classList.toggle('bg-slate-50',        !on);
        btn.classList.toggle('border-transparent', !on);
        btn.classList.toggle('text-slate-500',     !on);
    });
    // BMR calculado
    document.getElementById('cfg-bmr-display').innerText = calcBMR() + ' kcal/dia';

    // --- Lista de alimentos ---
    const listEl  = document.getElementById('food-log');
    listEl.innerHTML = '';
    let totalKcal = 0;

    day.foods.forEach(f => {
        totalKcal += f.kcal;
        const div = document.createElement('div');
        div.className = 'flex justify-between items-center bg-slate-50 p-3 rounded-2xl border border-slate-100';
        div.innerHTML = `
            <div class="flex items-center gap-3">
                <span class="text-xl">${f.icon}</span>
                <div>
                    <div class="text-[11px] font-black text-slate-700">${f.name}</div>
                    <div class="text-[10px] text-slate-400 font-bold">${f.qty}${f.unit} ‚Ä¢ ${Math.round(f.kcal)} kcal</div>
                </div>
            </div>
            <button onclick="removeFood(${f.id})" class="text-slate-200 hover:text-red-500">
                <span class="material-symbols-rounded">close</span>
            </button>`;
        listEl.appendChild(div);
    });
    document.getElementById('today-kcal-total').innerText = Math.round(totalKcal) + ' kcal';

    // --- Gap (seta currentNeededBurn + currentDailyTarget) ---
    analyzeGap(totalKcal);

    // --- Se√ß√£o de atividade ---
    updateActivitySection();

    // --- Dashboard: peso + progresso ---
    document.getElementById('dash-weight').innerText   = cfg.currentWeight + 'kg';
    document.getElementById('dash-goal-val').innerText = cfg.goalKg;
    const lost = cfg.startWeight - cfg.currentWeight;
    const pct  = Math.min(100, Math.max(0, (lost / cfg.goalKg) * 100));
    document.getElementById('dash-pct').innerText      = Math.round(pct) + '%';
    document.getElementById('dash-bar').style.width    = pct + '%';

    // --- Dashboard: stats ---
    updateDashStats();

    // --- Gr√°fico ---
    updateChart();
}

function updateDashStats() {
    const cfg           = window.APP_DATA.config;
    const totalKcalGoal = cfg.goalKg * 7700;
    let totalDeficit    = 0;
    let daysDone        = 0;
    let daysOnTrack     = 0;
    let runningDeficit  = 0;

    window.APP_DATA.days.forEach((d, idx) => {
        const hasData = d.foods.length > 0 || d.activityKm > 0 || d.weight;
        if (!hasData) return;

        const kIn     = d.foods.reduce((a, f) => a + f.kcal, 0);
        const actBurn = getActivityBurn(d);
        const deficit = (calcBMR() + actBurn) - kIn;

        // Alvo naquele ponto no tempo
        const remainAtPoint  = totalKcalGoal - runningDeficit;
        const daysAtPoint    = cfg.durationDays - idx;
        const targetAtPoint  = daysAtPoint > 0 ? remainAtPoint / daysAtPoint : remainAtPoint;

        if (deficit >= targetAtPoint) daysOnTrack++;

        runningDeficit += deficit;
        totalDeficit   += deficit;
        daysDone++;
    });

    document.getElementById('dash-deficit-total').innerText  = Math.round(totalDeficit) + ' kcal';
    document.getElementById('dash-deficit-pct').innerText    = `de ${Math.round(totalKcalGoal)} kcal necess√°rios`;
    document.getElementById('dash-days-done').innerText      = daysDone;
    document.getElementById('dash-days-remaining').innerText = `de ${cfg.durationDays} dias no plano`;

    const avgDeficit  = daysDone > 0 ? totalDeficit / daysDone : 0;
    const idealDaily  = totalKcalGoal / cfg.durationDays;
    document.getElementById('dash-avg-deficit').innerText  = daysDone > 0 ? Math.round(avgDeficit) + ' kcal' : '‚Äî kcal';
    document.getElementById('dash-avg-target').innerText   = `alvo: ${Math.round(idealDaily)} kcal/dia`;
    document.getElementById('dash-on-track').innerText     = daysOnTrack;
    document.getElementById('dash-on-track-pct').innerText = `de ${daysDone} registrados`;
}

// --- Navega√ß√£o ---
function switchView(view) {
    document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
    document.getElementById('view-' + view).classList.add('active');

    document.querySelectorAll('.nav-btn').forEach(b => {
        b.classList.remove('text-emerald-600');
        b.classList.add('text-slate-300');
    });
    const activeBtn = document.querySelector(`.nav-btn[data-id="${view}"]`);
    if (activeBtn) {
        activeBtn.classList.remove('text-slate-300');
        activeBtn.classList.add('text-emerald-600');
    }

    // Garantir dashboard sempre atualizado ao entrar
    if (view === 'dashboard') updateUI();
}

function changeDay(delta) {
    const n = currentDay + delta;
    if (n >= 1 && n <= window.APP_DATA.config.durationDays) {
        currentDay = n;
        updateUI();
    }
}

function goToToday() {
    currentDay = todayDay;
    updateUI();
}

// ============================================================
// ALIMENTA√á√ÉO
// ============================================================
function openFoodModal(type) {
    selectedFood = FOOD_DB[type];
    document.getElementById('m-food-icon').innerText = selectedFood.icon;
    document.getElementById('m-food-name').innerText = selectedFood.name;
    document.getElementById('m-food-unit').innerText = selectedFood.unit === 'g' ? 'GRAMAS' : 'UNIDADES';
    document.getElementById('m-food-qty').value      = selectedFood.unit === 'g' ? 100 : 2;
    document.getElementById('modal-food').classList.remove('hidden');
}

function closeFoodModal() {
    document.getElementById('modal-food').classList.add('hidden');
}

function confirmFood() {
    const qty = parseFloat(document.getElementById('m-food-qty').value);
    if (!qty) return;

    window.APP_DATA.days[currentDay - 1].foods.push({
        id:   Date.now(),
        name: selectedFood.name,
        icon: selectedFood.icon,
        unit: selectedFood.unit,
        qty:  qty,
        kcal: qty * selectedFood.kcal
    });

    closeFoodModal();
    saveAndSync();
    updateUI();
    playSound();
}

function removeFood(id) {
    const d = window.APP_DATA.days[currentDay - 1];
    d.foods = d.foods.filter(f => f.id !== id);
    saveAndSync();
    updateUI();
}

// ============================================================
// GR√ÅFICO (Chart.js)
// ============================================================
function initChart() {
    const ctx = document.getElementById('weightChart').getContext('2d');
    weightChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                data: [],
                borderColor: '#10b981',
                backgroundColor: 'rgba(16,185,129,0.1)',
                fill: true,
                tension: 0.4,
                borderWidth: 4,
                pointRadius: 5,
                pointBackgroundColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
                x: { display: false },
                y: { grid: { color:'#f1f5f9' }, ticks: { font: { size:10, weight:'bold' } } }
            }
        }
    });
}

function updateChart() {
    if (!weightChart) return;
    const labels = [], data = [];
    window.APP_DATA.days.forEach(d => {
        if (d.weight || d.day === 1) {
            labels.push(d.day);
            data.push(d.weight || window.APP_DATA.config.startWeight);
        }
    });
    weightChart.data.labels           = labels;
    weightChart.data.datasets[0].data = data;
    weightChart.update();
}

// ============================================================
// SOM
// ============================================================
function playSound() {
    try {
        const synth = new Tone.Synth().toDestination();
        synth.triggerAttackRelease('G5','32n');
    } catch(e) { /* sil√™ncio se indispon√≠vel */ }
}

// ============================================================
// QUINE DOWNLOAD ‚Äî salva estado dentro do pr√≥prio HTML
// ============================================================
function downloadApp() {
    saveAndSync();
    const state = JSON.stringify(window.APP_DATA);
    let html    = document.documentElement.outerHTML;
    const regex = /\/\* STATE_START \*\/[\s\S]*?\/\* STATE_END \*\//;
    const replacement = `/* STATE_START */ \n window.APP_DATA = ${state}; \n /* STATE_END */`;
    html = html.replace(regex, replacement);

    const blob = new Blob([html], { type:'text/html' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href     = url;
    a.download = 'index.html';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    alert('Arquivo index.html pronto para upload no GitHub!');
}
</script>
</body>
</html>
